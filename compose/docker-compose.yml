version: "3.8"

services:
  orchestrator:
    build:
      context: ..
      dockerfile: containers/orchestrator/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - SERVICE_NAME=orchestrator
      - STATE_SERVICE_URL=http://state-persistence:8008
      - FEATURE_DEV_URL=http://feature-dev:8002
      - CODE_REVIEW_URL=http://code-review:8003
      - INFRASTRUCTURE_URL=http://infrastructure:8004
      - CICD_URL=http://cicd:8005
      - DOCUMENTATION_URL=http://documentation:8006
    networks:
      - devtools-network
    volumes:
      - orchestrator-data:/data
    depends_on:
      - state-persistence

  feature-dev:
    build:
      context: ..
      dockerfile: containers/feature-dev/Dockerfile
    ports:
      - "8002:8002"
    environment:
      - SERVICE_NAME=feature-dev
      - RAG_SERVICE_URL=http://rag-context:8007
      - CODE_REVIEW_URL=http://code-review:8003
    networks:
      - devtools-network
    depends_on:
      - rag-context

  code-review:
    build:
      context: ..
      dockerfile: containers/code-review/Dockerfile
    ports:
      - "8003:8003"
    environment:
      - SERVICE_NAME=code-review
    networks:
      - devtools-network

  infrastructure:
    build:
      context: ..
      dockerfile: containers/infrastructure/Dockerfile
    ports:
      - "8004:8004"
    environment:
      - SERVICE_NAME=infrastructure
    networks:
      - devtools-network

  cicd:
    build:
      context: ..
      dockerfile: containers/cicd/Dockerfile
    ports:
      - "8005:8005"
    environment:
      - SERVICE_NAME=cicd
    networks:
      - devtools-network

  documentation:
    build:
      context: ..
      dockerfile: containers/documentation/Dockerfile
    ports:
      - "8006:8006"
    environment:
      - SERVICE_NAME=documentation
    networks:
      - devtools-network

  gateway-mcp:
    build:
      context: ..
      dockerfile: containers/gateway-mcp/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - SERVICE_NAME=gateway-mcp
      - NODE_ENV=production
      - LINEAR_OAUTH_DEV_TOKEN_FILE=/run/secrets/linear_oauth_token
      - LINEAR_WEBHOOK_SIGNING_SECRET_FILE=/run/secrets/linear_webhook_secret
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    volumes:
      - mcp-config:/app/config
    secrets:
      - linear_oauth_token
      - linear_webhook_secret

  # RAG Context Manager
  rag-context:
    build:
      context: ..
      dockerfile: containers/rag/Dockerfile
    ports:
      - "8007:8007"
    environment:
      - SERVICE_NAME=rag-context
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    networks:
      - devtools-network
    depends_on:
      - qdrant

  # State Persistence Layer
  state-persistence:
    build:
      context: ..
      dockerfile: containers/state/Dockerfile
    ports:
      - "8008:8008"
    environment:
      - SERVICE_NAME=state-persistence
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=changeme
    networks:
      - devtools-network
    depends_on:
      - postgres

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - devtools-network
    volumes:
      - qdrant-data:/qdrant/storage

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=devtools
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=changeme
    networks:
      - devtools-network
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d devtools"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  orchestrator-data:
  mcp-config:
  qdrant-data:
  postgres-data:

secrets:
  linear_oauth_token:
    file: ../config/env/secrets/linear_oauth_token.txt
  linear_webhook_secret:
    file: ../config/env/secrets/linear_webhook_secret.txt

networks:
  devtools-network:
    name: devtools-network
