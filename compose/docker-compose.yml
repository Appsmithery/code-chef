services:
  # NOTE: Agent services (orchestrator, feature-dev, code-review, infrastructure, cicd, documentation)
  # are deployed as Gradient AI managed agents. See DigitalOcean dashboard for endpoints.
  # Only gateway-mcp, rag-context, state-persistence, and databases run in Docker.

  gateway-mcp:
    image: ${DOCR_REGISTRY:-registry.digitalocean.com/the-shop-infra}/gateway-mcp:${IMAGE_TAG:-local}
    build:
      context: ..
      dockerfile: containers/gateway-mcp/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - SERVICE_NAME=gateway-mcp
      - NODE_ENV=production
      - LINEAR_OAUTH_DEV_TOKEN_FILE=/run/secrets/linear_oauth_token
      - LINEAR_WEBHOOK_SIGNING_SECRET_FILE=/run/secrets/linear_webhook_secret
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    volumes:
      - mcp-config:/app/config
    secrets:
      - linear_oauth_token
      - linear_webhook_secret

  # RAG Context Manager
  rag-context:
    image: ${DOCR_REGISTRY:-registry.digitalocean.com/the-shop-infra}/rag-context:${IMAGE_TAG:-local}
    build:
      context: ..
      dockerfile: containers/rag/Dockerfile
    ports:
      - "8007:8007"
    environment:
      - SERVICE_NAME=rag-context
      - QDRANT_HOST=${QDRANT_HOST:-qdrant}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - QDRANT_URL=${QDRANT_URL:-}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-the-shop}
      - QDRANT_VECTOR_SIZE=${QDRANT_VECTOR_SIZE:-1536}
      - QDRANT_DISTANCE=${QDRANT_DISTANCE:-cosine}
      - GRADIENT_API_KEY=${GRADIENT_API_KEY}
      - GRADIENT_BASE_URL=${GRADIENT_BASE_URL:-https://api.digitalocean.com/v2/ai}
      - GRADIENT_EMBEDDING_MODEL=${GRADIENT_EMBEDDING_MODEL:-text-embedding-3-large}
      - EMBEDDING_TIMEOUT=${EMBEDDING_TIMEOUT:-60}
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - MCP_TIMEOUT=30
    networks:
      - devtools-network
    depends_on:
      - qdrant
      - gateway-mcp

  # State Persistence Layer
  state-persistence:
    image: ${DOCR_REGISTRY:-registry.digitalocean.com/the-shop-infra}/state-persistence:${IMAGE_TAG:-local}
    build:
      context: ..
      dockerfile: containers/state/Dockerfile
    ports:
      - "8008:8008"
    environment:
      - SERVICE_NAME=state-persistence
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=changeme
    networks:
      - devtools-network
    depends_on:
      - postgres

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - devtools-network
    volumes:
      - qdrant-data:/qdrant/storage

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=devtools
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=changeme
    networks:
      - devtools-network
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d devtools"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ../config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
    networks:
      - devtools-network
    restart: unless-stopped

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    environment:
      - OAUTH2_PROXY_PROVIDER=${OAUTH2_PROXY_PROVIDER:-github}
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_PROXY_CLIENT_ID:-placeholder-client-id}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_PROXY_CLIENT_SECRET:-placeholder-client-secret}
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET:-c2VjdXJlLWNvb2tpZS1zZWVkLTAwMTIzNDU2Nzg5MDEyMzQ1Ng==}
      - OAUTH2_PROXY_REDIRECT_URL=${OAUTH2_PROXY_REDIRECT_URL:-http://localhost/oauth2/callback}
      - OAUTH2_PROXY_EMAIL_DOMAINS=${OAUTH2_PROXY_ALLOWED_EMAILS:-*}
      - OAUTH2_PROXY_GITHUB_ORG=${OAUTH2_PROXY_GITHUB_ORG:-}
      - OAUTH2_PROXY_UPSTREAMS=http://prometheus:9090
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_COOKIE_SECURE=false
      - OAUTH2_PROXY_COOKIE_HTTPONLY=true
      - OAUTH2_PROXY_REVERSE_PROXY=true
    networks:
      - devtools-network
    depends_on:
      - prometheus

  caddy:
    image: caddy:2.8.4-alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      - CADDY_DOMAIN=${CADDY_DOMAIN:-:80}
      - CADDY_ACME_EMAIL=${CADDY_ACME_EMAIL:-}
    volumes:
      - ../config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - oauth2-proxy

volumes:
  orchestrator-data:
  mcp-config:
  qdrant-data:
  postgres-data:
  prometheus-data:
  caddy-data:
  caddy-config:

secrets:
  linear_oauth_token:
    file: ../config/env/secrets/linear_oauth_token.txt
  linear_webhook_secret:
    file: ../config/env/secrets/linear_webhook_secret.txt

networks:
  devtools-network:
    name: devtools-network
