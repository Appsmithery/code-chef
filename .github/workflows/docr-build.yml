name: Build and Push to DOCR

on:
  push:
    branches: [main]
    paths:
      - "containers/**"
      - "agents/**"
      - "compose/docker-compose.yml"
      - "config/env/.env.template"
      - ".github/workflows/docr-build.yml"
  workflow_dispatch:

env:
  DOCR_REGISTRY: registry.digitalocean.com/the-shop-infra
  DROPLET_HOST: do-mcp-gateway
  DEPLOY_PATH: /opt/Dev-Tools

jobs:
  build-and-push:
    name: Build and Push All Services
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set_tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set IMAGE_TAG
        id: set_tag
        run: echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1800

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare .env file for compose
        run: |
          cp config/env/.env.template config/env/.env
          echo "GRADIENT_API_KEY=${{ secrets.GRADIENT_API_KEY }}" >> config/env/.env
          echo "LANGCHAIN_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" >> config/env/.env
          echo "LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}" >> config/env/.env
          echo "LANGSMITH_WORKSPACE_ID=${{ secrets.LANGSMITH_WORKSPACE_ID }}" >> config/env/.env
          echo "QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}" >> config/env/.env
          echo "QDRANT_URL=${{ secrets.QDRANT_URL }}" >> config/env/.env
          echo "LINEAR_OAUTH_DEV_TOKEN=${{ secrets.LINEAR_OAUTH_DEV_TOKEN }}" >> config/env/.env
          echo "LINEAR_WEBHOOK_SIGNING_SECRET=${{ secrets.LINEAR_WEBHOOK_SIGNING_SECRET }}" >> config/env/.env

      - name: Build all services with docker compose
        env:
          IMAGE_TAG: ${{ steps.set_tag.outputs.tag }}
          DOCR_REGISTRY: ${{ env.DOCR_REGISTRY }}
        run: |
          docker compose --env-file config/env/.env -f deploy/docker-compose.yml build

      - name: Push all services to DOCR
        env:
          IMAGE_TAG: ${{ steps.set_tag.outputs.tag }}
          DOCR_REGISTRY: ${{ env.DOCR_REGISTRY }}
        run: |
          docker compose --env-file config/env/.env -f deploy/docker-compose.yml push

      - name: Clean up builder cache
        if: always()
        run: |
          docker builder prune -f
          docker image prune -f

      - name: Generate build metadata report
        if: always()
        run: |
          mkdir -p reports
          cat > reports/build-metadata.json <<EOF
          {
            "workflow_run": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "image_tag": "${{ steps.set_tag.outputs.tag }}",
            "registry": "${{ env.DOCR_REGISTRY }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          cat reports/build-metadata.json

  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H $(echo ${{ env.DROPLET_HOST }} | cut -d'@' -f2) >> ~/.ssh/known_hosts

      - name: Pull latest code on droplet
        run: |
          ssh ${{ env.DROPLET_HOST }} "cd ${{ env.DEPLOY_PATH }} && git pull origin main"

      - name: Install doctl on droplet
        run: |
          ssh ${{ env.DROPLET_HOST }} "command -v doctl || (cd /tmp && curl -sL https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz | tar xz && sudo mv doctl /usr/local/bin/)"

      - name: Login to DOCR on droplet
        run: |
          ssh ${{ env.DROPLET_HOST }} "echo '${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}' | doctl auth init --access-token - && doctl registry login --expiry-seconds 1800"

      - name: Deploy with compose pull
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          ssh ${{ env.DROPLET_HOST }} "cd ${{ env.DEPLOY_PATH }}/deploy && \
            export IMAGE_TAG=${{ env.IMAGE_TAG }} && \
            export DOCR_REGISTRY=${{ env.DOCR_REGISTRY }} && \
            docker compose down --remove-orphans && \
            docker compose pull && \
            docker compose up -d"

      - name: Wait for services to initialize
        run: sleep 30

      - name: Run health checks
        run: |
          ssh ${{ env.DROPLET_HOST }} "curl -s http://localhost:8000/health"
          ssh ${{ env.DROPLET_HOST }} "curl -s http://localhost:8001/health"

      - name: Cleanup on failure
        if: failure()
        run: |
          ssh ${{ env.DROPLET_HOST }} "cd ${{ env.DEPLOY_PATH }}/deploy && docker compose logs --tail=100 && docker system prune --volumes --force"
