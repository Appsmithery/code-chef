name: Deploy Frontend to Production

on:
  workflow_dispatch: # Manual trigger only

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Copy built files to server
        run: |
          # Create SSH key file
          echo "${{ secrets.DROPLET_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          # Sync dist folder to server (correct path that Caddy mounts)
          rsync -avz --delete -e "ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no" \
            frontend/dist/ ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:/opt/code-chef/support/frontend/dist/
          # Cleanup
          rm /tmp/deploy_key

      - name: Restart Caddy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd /opt/code-chef/deploy
            docker compose restart caddy
            echo "‚úÖ Frontend deployed and Caddy restarted"

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."
          sleep 3
          curl -f https://codechef.appsmithery.co/ || exit 1
          echo "‚úÖ Homepage is live"
