name: Deploy Frontend to Production

on:
    push:
        branches:
            - main
        paths:
            - "support/frontend/src/**"
            - "support/frontend/public/**"
            - "support/frontend/package.json"
            - "support/frontend/vite.config.ts"
            - "support/frontend/tailwind.config.ts"

    workflow_dispatch: # Allow manual triggers

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              working-directory: support/frontend
              run: npm install

            - name: Build production bundle
              working-directory: support/frontend
              run: npm run build

            - name: Deploy to DigitalOcean
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.DROPLET_HOST }}
                  username: ${{ secrets.DROPLET_USER }}
                  key: ${{ secrets.DROPLET_SSH_KEY }}
                  script: |
                      cd /opt/Dev-Tools
                      git pull origin main
                      cd support/frontend
                      npm install
                      npm run build
                      cd /opt/Dev-Tools/deploy
                      docker compose restart caddy
                      echo "‚úÖ Frontend deployed successfully"

            - name: Verify deployment
              run: |
                  echo "üîç Verifying deployment..."
                  curl -f https://codechef.appsmithery.co/ || exit 1
                  echo "‚úÖ Homepage is live"
