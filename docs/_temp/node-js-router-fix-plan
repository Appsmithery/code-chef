# **Node.js MCP Gateway Fix Plan**

## üî¥ Issues Found

### 1. **MCP Gateway Tool Endpoints - 404 Errors**

```
INFO:httpx:HTTP Request: POST http://gateway-mcp:8000/tools/time/get_current_time "HTTP/1.1 404 Not Found"
INFO:httpx:HTTP Request: POST http://gateway-mcp:8000/tools/memory/create_entities "HTTP/1.1 404 Not Found"
```

**Root Cause:** The MCP Gateway is a **Node.js service** (see [`mcp/gateway/app.js`](mcp/gateway/app.js)), but the Python agents are trying to call `/tools/*` endpoints that don't exist in the Node.js router.

**Current Gateway Routes (Node.js):**

- ‚úÖ `/health`
- ‚úÖ `/oauth/linear/install`
- ‚úÖ `/oauth/linear/callback`
- ‚úÖ `/oauth/linear/status`
- ‚úÖ `/api/linear-issues`
- ‚úÖ `/api/linear-project/:projectId`
- ‚ùå `/tools/*` (NOT IMPLEMENTED)

### 2. **State Persistence Errors - 500 Internal Server Error**

```
INFO:httpx:HTTP Request: POST http://state-persistence:8008/tasks "HTTP/1.1 500 Internal Server Error"
INFO:httpx:HTTP Request: POST http://state-persistence:8008/workflows "HTTP/1.1 500 Internal Server Error"
INFO:httpx:HTTP Request: POST http://state-persistence:8008/compliance "HTTP/1.1 422 Unprocessable Entity"
```

---

## üõ†Ô∏è Required Fixes

### Fix 1: Add `/tools/*` Routes to Node.js Gateway

The gateway needs to proxy tool requests to MCP servers. Let me check if there's server discovery logic:

```javascript
import express from "express";
import { buildLinearAuthorizeUrl } from "./config/linearConfig.js";
import {
  exchangeAuthorizationCode,
  fetchProjectRoadmap,
  fetchRoadmapIssues,
  getTokenStatus,
  LinearAuthErrors,
} from "./services/linear.js";
import { consumeState, createState } from "./utils/oauthState.js";

const router = express.Router();

// ...existing routes...

// MCP Tool Proxy Routes
router.post("/tools/:server/:tool", async (req, res) => {
  const { server, tool } = req.params;
  const { params } = req.body;

  // TODO: Implement MCP server discovery and tool invocation
  // For now, return 501 Not Implemented with clear message
  console.warn(`[MCP] Tool request not yet implemented: ${server}/${tool}`);

  res.status(501).json({
    success: false,
    error: `MCP tool routing not yet implemented in Node.js gateway`,
    details: {
      server,
      tool,
      params,
      message:
        "The gateway is currently a Linear OAuth proxy. MCP tool routing requires MCP SDK integration.",
    },
  });
});

export default router;
```

### Fix 2: Make Orchestrator Handle MCP Unavailability Gracefully

The orchestrator should not fail when MCP tools are unavailable:

```python
async def get_current_time(self) -> str:
    """Fetch current timestamp from the time server, with fallback."""
    result = await self.invoke_tool("time", "get_current_time")
    if result.get("success"):
        payload = result.get("result")
        if isinstance(payload, dict):
            for key in ("iso_timestamp", "timestamp", "time", "current_time"):
                if key in payload:
                    return str(payload[key])
        if isinstance(payload, str):
            return payload

    # Fallback: Always return current time even if MCP fails
    return datetime.utcnow().isoformat()

async def log_event(
    self,
    event_type: str,
    metadata: Optional[Dict[str, Any]] = None,
    entity_type: str = "agent_event",
) -> bool:
    """Log an event to the shared memory server."""
    metadata = dict(metadata or {})
    metadata.setdefault("agent", self.agent_name)
    metadata.setdefault("event_type", event_type)
    metadata.setdefault("timestamp", await self.get_current_time())

    entity = {
        "name": metadata.get("name")
        or f"{self.agent_name}-{event_type}-{uuid.uuid4().hex[:8]}",
        "type": entity_type,
        "metadata": metadata,
    }

    result = await self.invoke_tool("memory", "create_entities", {"entities": [entity]})

    # CHANGE: Return False but don't crash - MCP unavailable is non-fatal
    if not result.get("success"):
        # Log warning but continue execution
        print(f"[MCP] Warning: Failed to log event to memory server (non-fatal): {result.get('error', 'Unknown error')}")

    return result.get("success", False)
```

### Fix 3: Update Documentation to Reflect Current State

```markdown
## Known Issues

### MCP Gateway Tool Routing Not Implemented

**Status:** Non-blocking - System operates with fallbacks

The Node.js MCP gateway currently only implements Linear OAuth routes. Tool proxy endpoints (`/tools/*`) return 501 Not Implemented.

**Impact:**

- ‚úÖ Orchestrator works fine - uses local timestamps as fallback
- ‚úÖ Event logging fails gracefully with warnings
- ‚ùå No centralized memory/time MCP tools available

**Workaround:** Agents use local fallbacks (datetime.utcnow() for time)

**Future Fix:** Implement MCP SDK integration in Node.js gateway to proxy tool requests to MCP servers.

### State Persistence 500 Errors

**Status:** Under investigation

The state-persistence service returns 500 errors on `/tasks` and `/workflows` endpoints.

**Impact:**

- ‚ö†Ô∏è Task persistence to PostgreSQL fails
- ‚úÖ Orchestrator uses in-memory fallback registry
- ‚úÖ System continues to function

**Next Steps:** Check state-persistence container logs for database connection issues.
```

---

## üéØ Immediate Action Plan

### Step 1: Add Tool Proxy Stub to Gateway

```bash
ssh root@45.55.173.72 "cd /opt/Dev-Tools && cat >> mcp/gateway/routes.js << 'EOF'

// MCP Tool Proxy (stub - returns clear error)
router.post('/tools/:server/:tool', async (req, res) => {
  const { server, tool } = req.params;
  console.warn(\`[MCP] Tool request not implemented: \${server}/\${tool}\`);
  res.status(501).json({
    success: false,
    error: 'MCP tool routing not yet implemented',
    server,
    tool
  });
});
EOF"
```

### Step 2: Investigate State Persistence

```bash
# Check state-persistence logs
ssh root@45.55.173.72 "docker logs compose-state-persistence-1 --tail 50"

# Check PostgreSQL connection
ssh root@45.55.173.72 "docker exec compose-state-persistence-1 env | grep POSTGRES"
```

### Step 3: Update Troubleshooting Guide

I'll update the guide to document these known issues and their non-blocking nature.

---

## ‚úÖ Summary

**Good News:**

- ‚úÖ Gradient AI working perfectly (463 tokens, successful decomposition)
- ‚úÖ Langfuse tracing operational
- ‚úÖ System degrades gracefully with fallbacks
- ‚úÖ No crashes - warnings logged but execution continues

**Issues to Fix:**

1. ‚ùå MCP Gateway missing `/tools/*` endpoints (501 Not Implemented stub needed)
2. ‚ö†Ô∏è State Persistence 500 errors (need to investigate)
3. ‚ö†Ô∏è MCP tool calls failing with 404 (non-fatal, using fallbacks)

**Priority:** **LOW** - System is operational and using fallbacks. These are enhancements for future phases.
