services:
  # ============================================================================
  # AGENT SERVICES (FastAPI containers)
  # ============================================================================

  # Orchestrator Agent - Task routing and workflow coordination
  orchestrator:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:orchestrator-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_orchestrator/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - AGENT_NAME=orchestrator
      - PORT=8001
      - GRADIENT_MODEL=llama3.3-70b-instruct
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - RAG_SERVICE_URL=http://rag-context:8007
      - STATE_SERVICE_URL=http://state-persistence:8008
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
      - HITL_POLICIES_PATH=/app/config/hitl/approval-policies.yaml
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - rag-context
      - state-persistence
      - agent-registry
      - redis
    volumes:
      - orchestrator-data:/app/data
      - ../config/hitl:/app/config/hitl:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # Feature Development Agent - Code generation
  feature-dev:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:feature-dev-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_feature-dev/Dockerfile
    ports:
      - "8002:8002"
    environment:
      - AGENT_NAME=feature-dev
      - PORT=8002
      - GRADIENT_MODEL=meta-codellama-34b-instruct
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - RAG_SERVICE_URL=http://rag-context:8007
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - rag-context
      - agent-registry
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1.5G
        reservations:
          cpus: "0.5"
          memory: 512M

  # Code Review Agent - PR analysis and security review
  code-review:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:code-review-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_code-review/Dockerfile
    ports:
      - "8003:8003"
    environment:
      - AGENT_NAME=code-review
      - PORT=8003
      - GRADIENT_MODEL=meta-llama-3.1-70b-instruct
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - RAG_SERVICE_URL=http://rag-context:8007
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - rag-context
      - agent-registry
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # Infrastructure Agent - Docker, Kubernetes, Terraform
  infrastructure:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:infrastructure-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_infrastructure/Dockerfile
    ports:
      - "8004:8004"
    environment:
      - AGENT_NAME=infrastructure
      - PORT=8004
      - GRADIENT_MODEL=meta-llama-3.1-8b-instruct
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - RAG_SERVICE_URL=http://rag-context:8007
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - rag-context
      - agent-registry
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # CI/CD Agent - Pipeline automation
  cicd:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:cicd-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_cicd/Dockerfile
    ports:
      - "8005:8005"
    environment:
      - AGENT_NAME=cicd
      - PORT=8005
      - GRADIENT_MODEL=meta-llama-3.1-8b-instruct
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - RAG_SERVICE_URL=http://rag-context:8007
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - rag-context
      - agent-registry
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # Documentation Agent - Docs generation and updates
  documentation:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:documentation-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_documentation/Dockerfile
    ports:
      - "8006:8006"
    environment:
      - AGENT_NAME=documentation
      - PORT=8006
      - GRADIENT_MODEL=mistralai-mistral-7b-instruct
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - RAG_SERVICE_URL=http://rag-context:8007
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - rag-context
      - agent-registry
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.75"
          memory: 768M
        reservations:
          cpus: "0.25"
          memory: 256M

  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  # MCP Gateway - Tool routing and Linear integration
  gateway-mcp:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:gateway-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/gateway/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - SERVICE_NAME=gateway-mcp
      - NODE_ENV=production
      - LINEAR_OAUTH_DEV_TOKEN_FILE=/run/secrets/linear_oauth_token
      - LINEAR_WEBHOOK_SIGNING_SECRET_FILE=/run/secrets/linear_webhook_secret
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    volumes:
      - mcp-config:/app/config
    secrets:
      - linear_oauth_token
      - linear_webhook_secret
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # RAG Context Manager
  rag-context:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:rag-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/rag/Dockerfile
    ports:
      - "8007:8007"
    environment:
      - SERVICE_NAME=rag-context
      - QDRANT_HOST=${QDRANT_HOST:-qdrant}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - QDRANT_URL=${QDRANT_URL:-}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-the-shop}
      - QDRANT_VECTOR_SIZE=${QDRANT_VECTOR_SIZE:-1536}
      - QDRANT_DISTANCE=${QDRANT_DISTANCE:-cosine}
      - GRADIENT_API_KEY=${GRADIENT_API_KEY:-}
      - GRADIENT_BASE_URL=${GRADIENT_BASE_URL:-https://api.digitalocean.com/v2/ai}
      - GRADIENT_EMBEDDING_MODEL=${GRADIENT_EMBEDDING_MODEL:-text-embedding-3-large}
      - EMBEDDING_TIMEOUT=${EMBEDDING_TIMEOUT:-60}
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - MCP_TIMEOUT=30
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # State Persistence Layer
  state-persistence:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:state-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/state/Dockerfile
    ports:
      - "8008:8008"
    environment:
      - SERVICE_NAME=state-persistence
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    networks:
      - devtools-network
    depends_on:
      - postgres
    secrets:
      - db_password
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

  # Agent Registry Service (Phase 6 - Multi-Agent Collaboration)
  agent-registry:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:agent-registry-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/agent-registry/Dockerfile
    ports:
      - "8009:8009"
    environment:
      - PORT=8009
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - HEARTBEAT_TIMEOUT_SECONDS=60
      - REDIS_URL=redis://redis:6379
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - postgres
      - redis
    secrets:
      - db_password
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8009/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    networks:
      - devtools-network
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../config/state:/docker-entrypoint-initdb.d
    secrets:
      - db_password
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devtools -d devtools"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Event Bus & Caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --appendfsync everysec --save 900 1 --save 300 10 --save 60 10000
    networks:
      - devtools-network
    volumes:
      - redis-data:/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LangGraph Workflow Service
  langgraph:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:langgraph-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/langgraph/Dockerfile
    ports:
      - "8010:8010"
    environment:
      - PORT=8010
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=devtools
      - DB_USER=devtools
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - MCP_GATEWAY_URL=http://gateway-mcp:8000
      - GRADIENT_MODEL_ACCESS_KEY=${GRADIENT_MODEL_ACCESS_KEY:-}
      - GRADIENT_MODEL=${GRADIENT_MODEL:-meta-llama-3.1-8b-instruct}
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - postgres
      - gateway-mcp
    secrets:
      - db_password
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ../config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../config/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
    networks:
      - devtools-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    environment:
      - OAUTH2_PROXY_PROVIDER=${OAUTH2_PROXY_PROVIDER:-github}
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_PROXY_CLIENT_ID:-placeholder-client-id}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_PROXY_CLIENT_SECRET:-placeholder-client-secret}
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET:-c2VjdXJlLWNvb2tpZS1zZWVkLTAwMTIzNDU2Nzg5MDEyMzQ1Ng==}
      - OAUTH2_PROXY_REDIRECT_URL=${OAUTH2_PROXY_REDIRECT_URL:-http://localhost/oauth2/callback}
      - OAUTH2_PROXY_EMAIL_DOMAINS=${OAUTH2_PROXY_ALLOWED_EMAILS:-*}
      - OAUTH2_PROXY_GITHUB_ORG=${OAUTH2_PROXY_GITHUB_ORG:-}
      - OAUTH2_PROXY_UPSTREAMS=http://prometheus:9090
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_COOKIE_SECURE=false
      - OAUTH2_PROXY_COOKIE_HTTPONLY=true
      - OAUTH2_PROXY_REVERSE_PROXY=true
    networks:
      - devtools-network
    depends_on:
      - prometheus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

  caddy:
    image: caddy:2.8.4-alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      - CADDY_DOMAIN=${CADDY_DOMAIN:-theshop.appsmithery.co}
      - CADDY_ACME_EMAIL=${CADDY_ACME_EMAIL:-alex@appsmithery.co}
    volumes:
      - ../config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ../support/frontend:/srv/frontend:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - devtools-network
    depends_on:
      - gateway-mcp
      - oauth2-proxy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

volumes:
  orchestrator-data:
  mcp-config:
  postgres-data:
  redis-data:
  prometheus-data:
  caddy-data:
  caddy-config:

secrets:
  db_password:
    file: ../config/env/secrets/db_password.txt
  linear_oauth_token:
    file: ../config/env/secrets/linear_oauth_token.txt
  linear_webhook_secret:
    file: ../config/env/secrets/linear_webhook_secret.txt

networks:
  devtools-network:
    name: devtools-network
