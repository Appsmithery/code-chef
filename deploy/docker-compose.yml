services:
  # ============================================================================
  # AGENT SERVICES (FastAPI containers)
  # ============================================================================

  # Orchestrator Agent - Task routing and workflow coordination
  orchestrator:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:orchestrator-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_orchestrator/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - AGENT_NAME=orchestrator
      - PORT=8001
      - GRADIENT_MODEL=llama3.3-70b-instruct
      - RAG_SERVICE_URL=http://rag-context:8007
      - STATE_SERVICE_URL=http://state-persistence:8008
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
      - HITL_POLICIES_PATH=/app/config/hitl/approval-policies.yaml
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - LINEAR_WEBHOOK_SIGNING_SECRET_FILE=/run/secrets/linear_webhook_secret
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-true}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-code-chef-production}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - TRACE_ENVIRONMENT=${TRACE_ENVIRONMENT:-production}
      - EXPERIMENT_GROUP=${EXPERIMENT_GROUP:-code-chef}
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - rag-context
      - state-persistence
      - agent-registry
      - redis
    volumes:
      - orchestrator-data:/app/data
      - ../config/hitl:/app/config/hitl:ro
      - ../config/linear:/app/config/linear:ro
      - ../config/env:/app/config/env:ro
      - ../config/mcp-agent-tool-mapping.yaml:/app/config/mcp-agent-tool-mapping.yaml:ro
      - ../config/prometheus:/app/config/prometheus:ro
      - ../config/agents/models.yaml:/config/agents/models.yaml:ro
      - ../agent_orchestrator/tools:/app/tools:ro
      - ../shared:/app/shared:ro
      - ../support/scripts:/app/support/scripts:ro
    secrets:
      - db_password
      - linear_webhook_secret
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  # RAG Context Manager
  rag-context:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:rag-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/rag/Dockerfile
    ports:
      - "8007:8007"
    environment:
      - SERVICE_NAME=rag-context
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8007/health')",
        ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # State Persistence Layer
  state-persistence:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:state-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/state/Dockerfile
    ports:
      - "8008:8008"
    environment:
      - SERVICE_NAME=state-persistence
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    networks:
      - devtools-network
    depends_on:
      - postgres
    secrets:
      - db_password
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8008/health')",
        ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

  # Agent Registry Service (Phase 6 - Multi-Agent Collaboration)
  agent-registry:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:agent-registry-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/agent-registry/Dockerfile
    ports:
      - "8009:8009"
    environment:
      - PORT=8009
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_PASSWORD=devtools_prod_2024_secure
      - HEARTBEAT_TIMEOUT_SECONDS=60
      - REDIS_URL=redis://redis:6379
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - postgres
      - redis
    secrets:
      - db_password
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8009/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    networks:
      - devtools-network
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../config/state:/docker-entrypoint-initdb.d
    secrets:
      - db_password
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devtools -d devtools"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Event Bus & Caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --appendfsync everysec --save 900 1 --save 300 10 --save 60 10000
    networks:
      - devtools-network
    volumes:
      - redis-data:/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 32M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LangGraph Workflow Service
  langgraph:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:langgraph-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/langgraph/Dockerfile
    ports:
      - "8010:8010"
    environment:
      - PORT=8010
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=devtools
      - DB_USER=devtools
      - DB_PASSWORD=devtools_prod_2024_secure
      - DB_PASSWORD_FILE=/run/secrets/db_password
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - postgres
    secrets:
      - db_password
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8010/health')",
        ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ../config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../config/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-lifecycle"
    networks:
      - devtools-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    environment:
      - OAUTH2_PROXY_UPSTREAMS=http://prometheus:9090
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_COOKIE_SECURE=false
      - OAUTH2_PROXY_COOKIE_HTTPONLY=true
      - OAUTH2_PROXY_REVERSE_PROXY=true
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - prometheus
    restart: unless-stopped
    healthcheck:
      disable: true
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

  caddy:
    image: caddy:2.8.4-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ../support/frontend/dist:/srv/frontend:ro
      - caddy-data:/data
      - caddy-config:/config
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      - orchestrator
      - oauth2-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    logging:
      driver: "json-file"
      options:
        tag: "{{.Name}}"

  # ============================================================================
  # OBSERVABILITY STACK (Grafana + Loki + Promtail)
  # ============================================================================

  grafana:
    image: grafana/grafana:10.2.3
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_GITHUB_SCOPES=user:email,read:org
      - GF_AUTH_GITHUB_AUTH_URL=https://github.com/login/oauth/authorize
      - GF_AUTH_GITHUB_TOKEN_URL=https://github.com/login/oauth/access_token
      - GF_AUTH_GITHUB_API_URL=https://api.github.com/user
      - GF_AUTH_GITHUB_ALLOW_SIGN_UP=true
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    env_file:
      - ../config/env/.env
    volumes:
      - grafana-data:/var/lib/grafana
      - ../config/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ../config/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - devtools-network
    depends_on:
      - prometheus
      - loki
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  loki:
    image: grafana/loki:2.9.3
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ../config/loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    networks:
      - devtools-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

  promtail:
    image: grafana/promtail:2.9.3
    volumes:
      - ../config/loki/promtail-config.yaml:/etc/promtail/config.yaml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yaml
    networks:
      - devtools-network
    depends_on:
      - loki
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

volumes:
  orchestrator-data:
  postgres-data:
  redis-data:
  prometheus-data:
  grafana-data:
  caddy-data:
  caddy-config:
  loki-data:

secrets:
  db_password:
    file: ../config/env/secrets/db_password.txt
  linear_webhook_secret:
    file: ../config/env/secrets/linear_webhook_secret.txt

networks:
  devtools-network:
    name: devtools-network
