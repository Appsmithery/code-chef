services:
  # ============================================================================
  # AGENT SERVICES (FastAPI containers)
  # ============================================================================

  # Orchestrator Agent - Task routing and workflow coordination
  orchestrator:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:orchestrator-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: agent_orchestrator/Dockerfile
    ports:
      - "8001:8001"
    environment:
      - AGENT_NAME=orchestrator
      - PORT=8001
      - RAG_SERVICE_URL=http://rag-context:8007
      - STATE_SERVICE_URL=http://state-persistence:8008
      - AGENT_REGISTRY_URL=http://agent-registry:8009
      - EVENT_BUS_URL=redis://redis:6379
      - HITL_POLICIES_PATH=/app/config/hitl/approval-policies.yaml
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - LINEAR_WEBHOOK_SIGNING_SECRET_FILE=/run/secrets/linear_webhook_secret
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-true}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-code-chef-production}
      - TRACE_ENVIRONMENT=${TRACE_ENVIRONMENT:-production}
      - EXPERIMENT_GROUP=${EXPERIMENT_GROUP:-code-chef}
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      rag-context:
        condition: service_healthy
      state-persistence:
        condition: service_healthy
      agent-registry:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - /opt/code-chef/data/orchestrator:/app/data
      - ../config/hitl:/app/config/hitl:ro
      - ../config/linear:/app/config/linear:ro
      - ../config/env:/app/config/env:ro
      - ../config/error-handling.yaml:/app/config/error-handling.yaml:ro
      - ../config/mcp-agent-tool-mapping.yaml:/app/config/mcp-agent-tool-mapping.yaml:ro
      - ../config/agents/models.yaml:/app/config/agents/models.yaml:ro
      - ../config/agents:/app/config/agents:ro
      - ../agent_orchestrator/tools:/app/tools:ro
      - ../shared:/app/shared:ro
      - ../support/scripts:/app/support/scripts:ro
    secrets:
      - db_password
      - linear_webhook_secret
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  # RAG Context Manager
  rag-context:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:rag-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/rag/Dockerfile
    ports:
      - "8007:8007"
    environment:
      - SERVICE_NAME=rag-context
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8007/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # State Persistence Layer
  state-persistence:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:state-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/state/Dockerfile
    ports:
      - "8008:8008"
    environment:
      - SERVICE_NAME=state-persistence
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    networks:
      - devtools-network
    depends_on:
      postgres:
        condition: service_healthy
    secrets:
      - db_password
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8008/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

  # Agent Registry Service (Phase 6 - Multi-Agent Collaboration)
  agent-registry:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:agent-registry-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/agent-registry/Dockerfile
    ports:
      - "8009:8009"
    environment:
      - PORT=8009
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_PASSWORD=devtools_prod_2024_secure
      - HEARTBEAT_TIMEOUT_SECONDS=60
      - REDIS_URL=redis://redis:6379
      - EVENT_BUS_URL=redis://redis:6379
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    secrets:
      - db_password
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8009/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=devtools
      - POSTGRES_USER=devtools
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    command:
      - postgres
      - -c
      - shared_buffers=64MB
      - -c
      - max_connections=50
      - -c
      - work_mem=4MB
      - -c
      - maintenance_work_mem=32MB
    networks:
      - devtools-network
    volumes:
      - /opt/code-chef/data/postgres:/var/lib/postgresql/data
      - ../config/state:/docker-entrypoint-initdb.d
    secrets:
      - db_password
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devtools -d devtools"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Redis for Event Bus & Caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --appendfsync everysec --save 900 1 --save 300 10 --save 60 10000 --maxmemory 64mb --maxmemory-policy allkeys-lru
    networks:
      - devtools-network
    volumes:
      - /opt/code-chef/data/redis:/data
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 32M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # LangGraph Workflow Service
  langgraph:
    image: ${DOCKER_USERNAME:-alextorelli28}/appsmithery:langgraph-${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: shared/services/langgraph/Dockerfile
    ports:
      - "8010:8010"
    environment:
      - PORT=8010
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=devtools
      - DB_USER=devtools
      - DB_PASSWORD=devtools_prod_2024_secure
      - DB_PASSWORD_FILE=/run/secrets/db_password
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      postgres:
        condition: service_healthy
    secrets:
      - db_password
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8010/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

  caddy:
    image: caddy:2.8.4-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ../support/frontend/dist:/srv/frontend:ro
      - caddy-data:/data
      - caddy-config:/config
    env_file:
      - ../config/env/.env
    networks:
      - devtools-network
    depends_on:
      orchestrator:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "caddy", "validate", "--config", "/etc/caddy/Caddyfile"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"

volumes:
  caddy-data:
  caddy-config:

secrets:
  db_password:
    file: ../config/env/secrets/db_password.txt
  linear_webhook_secret:
    file: ../config/env/secrets/linear_webhook_secret.txt

networks:
  devtools-network:
    name: devtools-network
