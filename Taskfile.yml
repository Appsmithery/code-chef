version: "3"

# Dev-Tools Infrastructure & Deployment Workflows
# Focus: Docker lifecycle, remote deployment, health validation

vars:
  DEPLOY_DIR: deploy
  DROPLET_IP: 45.55.173.72
  DROPLET_PATH: /opt/Dev-Tools

tasks:
  default:
    desc: Show available infrastructure commands
    cmds:
      - task --list

  =============================================================================
  # LOCAL STACK LIFECYCLE
  =============================================================================

  local_deploy:up:
    desc: Start full local stack with health checks
    summary: |
      Starts all Docker services in detached mode, waits 15 seconds for
      initialization, then runs health checks on all services.
    dir: "{{.DEPLOY_DIR}}"
    cmds:
      - docker compose up -d
      - echo "â³ Waiting 15s for initialization..."
      - sleep 15
      - task: health

  local_deploy:down:
    desc: Stop and clean up local stack
    summary: |
      Stops all services, removes orphaned containers, and prunes unused
      Docker builder cache. Safe for regular development use.
    dir: "{{.DEPLOY_DIR}}"
    cmds:
      - docker compose down --remove-orphans
      - docker builder prune -f

  local_deploy:rebuild:
    desc: Rebuild all images and restart stack
    summary: |
      Nuclear rebuild: stops services, rebuilds all images without cache,
      starts stack, and runs health checks. Use when dependencies change.
    dir: "{{.DEPLOY_DIR}}"
    cmds:
      - docker compose down
      - docker compose build --no-cache
      - docker compose up -d
      - task: health

  local_deploy:logs:
    desc: Stream logs from all services (Ctrl+C to exit)
    dir: "{{.DEPLOY_DIR}}"
    cmds:
      - docker compose logs -f --tail=50

  local_deploy:ps:
    desc: Show running services and their ports
    dir: "{{.DEPLOY_DIR}}"
    cmds:
      - docker compose ps

  local_deploy:clean:
    desc: Nuclear cleanup - remove all containers, volumes, images
    summary: |
      âš ï¸  DESTRUCTIVE: Removes all containers, volumes, images, networks, and
      build cache. This will delete ALL local data including databases.
    dir: "{{.DEPLOY_DIR}}"
    cmds:
      - docker compose down -v
      - docker system prune --all --volumes --force
      - echo "âœ… Cleanup complete"

  =============================================================================
  # BUILD & REGISTRY
  =============================================================================

  build:local:
    desc: Build all agent images locally
    summary: |
      Builds all 6 agent images plus gateway, RAG, and state services using
      docker-compose.yml definitions. Uses cache for faster builds.
    dir: "{{.DEPLOY_DIR}}"
    cmds:
      - docker compose build

  build:push_docker_hub:
    desc: Push images to Docker Hub (apscolabs/dev-tools-*)
    summary: |
      Tags and pushes all Dev-Tools images to Docker Hub registry under
      apscolabs organization. Requires Docker Hub authentication.
    cmds:
      - pwsh ./support/scripts/deploy/push-dockerhub.ps1

  build:push_docr:
    desc: Push images to DigitalOcean Container Registry
    summary: |
      Tags and pushes all images to DigitalOcean Container Registry.
      Requires doctl authentication and DOCR repository setup.
    cmds:
      - pwsh ./support/scripts/deploy/push-docr.ps1

  =============================================================================
  # REMOTE DEPLOYMENT (DROPLET)
  =============================================================================

  prod_deploy:droplet:
    desc: Deploy to DigitalOcean droplet (git pull + rebuild + health)
    summary: |
      Full deployment workflow: SSH to droplet, pull latest code, rebuild
      all images, restart services, wait 20s, then run remote health checks.
    cmds:
      - |
        echo "ğŸš€ Deploying to {{.DROPLET_IP}}..."
        ssh root@{{.DROPLET_IP}} "cd {{.DROPLET_PATH}} && \
          git pull origin main && \
          cd deploy && \
          docker compose down --remove-orphans && \
          docker builder prune -f && \
          docker compose build && \
          docker compose up -d"
        echo "â³ Waiting 20s for services to start..."
        sleep 20
        task: health:remote

  prod_deploy:docr:
    desc: Deploy pre-built DOCR images to droplet (no rebuild)
    summary: |
      Fast deployment: pulls pre-built images from DOCR and restarts services
      on droplet. Skips rebuild step. Requires prior push:docr.
    cmds:
      - pwsh ./deploy-to-droplet.ps1

  prod_deploy:restart:
    desc: Restart services on droplet without rebuild
    summary: |
      Quick restart of all services on droplet using existing images.
      Useful for applying environment variable changes.
    cmds:
      - |
        ssh root@{{.DROPLET_IP}} "cd {{.DROPLET_PATH}}/deploy && \
          docker compose restart"
        task: health:remote

  =============================================================================
  # HEALTH & VALIDATION
  =============================================================================

  health:local:
    desc: Check health of local services (ports 8000-8008)
    summary: |
      Checks /health endpoints for all 9 services on localhost. Reports
      status with âœ…/âŒ indicators. Use after 'up' or 'rebuild'.
    cmds:
      - |
        echo "ğŸ¥ Checking local service health..."
        services=(
          "8000:gateway-mcp"
          "8001:orchestrator"
          "8002:feature-dev"
          "8003:code-review"
          "8004:infrastructure"
          "8005:cicd"
          "8006:documentation"
          "8007:rag-context"
          "8008:state-persistence"
        )
        for svc in "${services[@]}"; do
          port="${svc%%:*}"
          name="${svc##*:}"
          status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$port/health 2>/dev/null || echo "000")
          if [ "$status" = "200" ]; then
            echo "  âœ… $name (port $port)"
          else
            echo "  âŒ $name (port $port) - HTTP $status"
          fi
        done

  health:remote:
    desc: Check health of droplet services
    summary: |
      Checks /health endpoints for all 9 services on droplet (45.55.173.72).
      Use after deployment to verify successful startup.
    cmds:
      - |
        echo "ğŸ¥ Checking droplet service health..."
        services=(
          "8000:gateway-mcp"
          "8001:orchestrator"
          "8002:feature-dev"
          "8003:code-review"
          "8004:infrastructure"
          "8005:cicd"
          "8006:documentation"
          "8007:rag-context"
          "8008:state-persistence"
        )
        for svc in "${services[@]}"; do
          port="${svc%%:*}"
          name="${svc##*:}"
          status=$(curl -s -o /dev/null -w "%{http_code}" http://{{.DROPLET_IP}}:$port/health 2>/dev/null || echo "000")
          if [ "$status" = "200" ]; then
            echo "  âœ… $name (port $port)"
          else
            echo "  âŒ $name (port $port) - HTTP $status"
          fi
        done

  health:trace:
    desc: Validate LangSmith tracing is working
    summary: |
      Runs validation script to test LangSmith tracing integration. Checks
      environment variables and makes test LLM call to generate trace.
    cmds:
      - bash ./support/scripts/validation/validate-tracing.sh
      - echo "ğŸ“Š View traces at https://smith.langchain.com"

  =============================================================================
  # DROPLET ADMIN
  =============================================================================

  droplet:connect_ssh:
    desc: SSH into droplet
    summary: Opens SSH session to production droplet as root user.
    cmds:
      - ssh root@{{.DROPLET_IP}}

  droplet:check_status:
    desc: Show droplet stack status and disk usage
    summary: |
      Comprehensive droplet status report: running services, disk usage,
      current git branch, and latest commit. Quick health overview.
    cmds:
      - |
        echo "ğŸ“Š Droplet Status ({{.DROPLET_IP}}):"
        ssh root@{{.DROPLET_IP}} "cd {{.DROPLET_PATH}}/deploy && \
          echo '=== Docker Services ===' && \
          docker compose ps && \
          echo '' && \
          echo '=== Disk Usage ===' && \
          df -h /opt && \
          echo '' && \
          echo '=== Git Branch ===' && \
          cd .. && git branch --show-current && git log -1 --oneline"

  droplet:backup:
    desc: Backup droplet volumes to local machine
    summary: |
      Creates timestamped backup of all Docker volumes from droplet and
      downloads to local ./backups/ directory via SCP.
    cmds:
      - |
        timestamp=$(date +%Y%m%d_%H%M%S)
        backup_dir="./backups/$timestamp"
        mkdir -p "$backup_dir"
        echo "ğŸ“¦ Backing up droplet volumes to $backup_dir..."
        ssh root@{{.DROPLET_IP}} "cd {{.DROPLET_PATH}} && \
          ./support/scripts/data/backup_volumes.sh"
        scp root@{{.DROPLET_IP}}:{{.DROPLET_PATH}}/backups/latest/*.tar.gz "$backup_dir/"
        echo "âœ… Backup complete: $backup_dir"

  =============================================================================
  # UTILITIES
  =============================================================================

  utilities:env:
    desc: Show required environment variables status
    summary: |
      Validates config/env/.env file and reports which required variables
      are configured. Checks for Gradient, LangSmith, and Linear keys.
    cmds:
      - |
        echo "ğŸ”‘ Environment Configuration Status:"
        required_vars=(
          "GRADIENT_MODEL_ACCESS_KEY"
          "LANGCHAIN_API_KEY"
          "LANGCHAIN_PROJECT"
          "LINEAR_OAUTH_DEV_TOKEN"
        )
        for var in "${required_vars[@]}"; do
          if grep -q "^$var=" config/env/.env 2>/dev/null; then
            echo "  âœ… $var"
          else
            echo "  âŒ $var (missing)"
          fi
        done

  utilities:ports:
    desc: Show port mappings and service URLs
    summary: |
      Reference guide showing all service port mappings (8000-8008, 9090)
      and their purposes. Useful for debugging connectivity issues.
    cmds:
      - |
        echo "ğŸ”Œ Service Port Mappings:"
        echo "  8000 â†’ gateway-mcp (MCP tool routing)"
        echo "  8001 â†’ orchestrator (task delegation)"
        echo "  8002 â†’ feature-dev (code generation)"
        echo "  8003 â†’ code-review (PR analysis)"
        echo "  8004 â†’ infrastructure (Docker/K8s)"
        echo "  8005 â†’ cicd (pipeline automation)"
        echo "  8006 â†’ documentation (docs generation)"
        echo "  8007 â†’ rag-context (vector search)"
        echo "  8008 â†’ state-persistence (workflow DB)"
        echo "  9090 â†’ prometheus (metrics)"
