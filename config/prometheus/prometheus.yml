# Prometheus Scrape Configuration for Dev-Tools Agent Stack
# https://prometheus.io/docs/prometheus/latest/configuration/configuration/

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: "dev-tools"
    environment: "development"

# Scrape configurations for all services
scrape_configs:
  # ===== Agent Services =====
  # NOTE: Post-DEV-123 LangGraph migration - all agents are nodes within orchestrator (port 8001)
  # Agent nodes (feature-dev, code-review, infrastructure, cicd, documentation) are NOT separate services
  # They run as workflow nodes within the orchestrator and export metrics via orchestrator:8001/metrics

  - job_name: "orchestrator"
    static_configs:
      - targets: ["orchestrator:8001"]
        labels:
          service: "orchestrator"
          agent_type: "coordinator"
          role: "task-routing"
          architecture: "langgraph-multi-node"
          # Note: Metrics from all 6 agent nodes (supervisor, feature-dev, code-review,
          # infrastructure, cicd, documentation) are aggregated and exposed via this endpoint

  # ===== Support Services =====

  - job_name: "gateway-mcp"
    static_configs:
      - targets: ["gateway-mcp:8000"]
        labels:
          service: "gateway"
          type: "mcp-bridge"
          role: "tool-coordination"

  - job_name: "rag-context"
    static_configs:
      - targets: ["rag-context:8007"]
        labels:
          service: "rag"
          type: "context-store"
          role: "knowledge-retrieval"
    # Longer scrape interval for RAG service
    scrape_interval: 30s

  - job_name: "state-persistence"
    static_configs:
      - targets: ["state-persistence:8008"]
        labels:
          service: "state"
          type: "persistence"
          role: "workflow-state"

  - job_name: "agent-registry"
    static_configs:
      - targets: ["agent-registry:8009"]
        labels:
          service: "agent-registry"
          type: "discovery"
          role: "agent-coordination"
    scrape_interval: 15s

  # ===== Data Stores =====
  # Note: Enable these if postgres_exporter and qdrant expose metrics

  # - job_name: 'postgres'
  #   static_configs:
  #     - targets: ['postgres:9187']  # Requires postgres_exporter
  #       labels:
  #         service: 'postgres'
  #         type: 'database'

  # - job_name: 'qdrant'
  #   static_configs:
  #     - targets: ['qdrant:6333']  # Check if Qdrant exposes Prometheus metrics
  #       labels:
  #         service: 'qdrant'
  #         type: 'vectordb'

  # ===== Prometheus Self-Monitoring =====

  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
        labels:
          service: "prometheus"
          type: "monitoring"

# Alerting rules
rule_files:
  - "alerts.yml"
# Remote write configuration (optional - for long-term storage)
# remote_write:
#   - url: "http://remote-storage:9009/api/v1/write"
