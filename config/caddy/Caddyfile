codechef.appsmithery.co {
	# Health check endpoint (highest priority)
	handle /health {
		reverse_proxy orchestrator:8001
	}

	# Chat stream endpoint (SSE streaming) - BEFORE root handler!
	# CRITICAL: flush_interval -1 disables response buffering for real-time SSE
	handle /chat/stream {
		reverse_proxy orchestrator:8001 {
			flush_interval -1      # Disable buffering - send SSE chunks immediately
			transport http {
				read_timeout 5m    # Allow long-running LLM conversations
				write_timeout 5m   # Prevent premature connection close
			}
		}
	}

	# Execute stream endpoint (Agent mode SSE streaming)
	handle /execute/stream {
		reverse_proxy orchestrator:8001 {
			flush_interval -1      # Disable buffering for SSE
			transport http {
				read_timeout 5m
				write_timeout 5m
			}
		}
	}

	# Test stream endpoint (diagnostic SSE streaming)
	handle /test/stream {
		reverse_proxy orchestrator:8001 {
			flush_interval -1      # Disable buffering for SSE
			transport http {
				read_timeout 5m
				write_timeout 5m
			}
		}
	}

	# Execute endpoint (orchestrator workflows - non-streaming)
	handle /execute* {
		reverse_proxy orchestrator:8001
	}

	# API endpoints (strip /api prefix before proxying)
	handle /api/* {
		uri strip_prefix /api
		reverse_proxy orchestrator:8001
	}

	# Linear webhooks
	handle /webhooks/linear {
		reverse_proxy orchestrator:8001
	}

	# Metrics endpoint (orchestrator)
	handle /metrics* {
		reverse_proxy orchestrator:8001
	}

	# Service endpoints (strip prefix)
	handle /rag/* {
		uri strip_prefix /rag
		reverse_proxy rag-context:8007
	}
	handle /state/* {
		uri strip_prefix /state
		reverse_proxy state-persistence:8008
	}
	handle /langgraph/* {
		uri strip_prefix /langgraph
		reverse_proxy langgraph:8010
	}

	# Frontend SPA (fallback for unmatched routes including root)
	handle {
		root * /srv/frontend
		encode gzip
		try_files {path} /index.html
		file_server
	}

	# HTTPS with Let's Encrypt Staging (TEMPORARY - bypass production rate limit)
	tls alex@appsmithery.co {
		ca https://acme-staging-v02.api.letsencrypt.org/directory
	}
}
